/**
 * sofa-coupon-service - v0.4.0 - Wed Mar 25 2015 14:49:38 GMT+0100 (CET)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(e){"use strict";e.define("sofa.CouponService",function(o,t,r,n,a,u){var c={},i={"Content-Type":"application/x-www-form-urlencoded"},d=u.get("checkoutUrl"),f=d+"coupon.php";c.submitCode=function(u){if(!u)return t.reject(new Error("No couponCode given!"));var c={task:"INFO",coupon:u,quote:JSON.stringify(n.createQuoteData())};return o({method:"POST",url:f,headers:i,transformRequest:e.Util.toFormData,data:c}).then(function(e){return e.data.error?t.reject(e.data.error):(r.addCoupon(e.data),e.data)},function(e){return a.error(["[CouponService: submitCode]","[Request Data]",c,"[Service answer]",e]),t.reject(e)})};var s=function(){var e=r.getActiveCoupons(),o=e.map(function(e){return e.code});r.clearCoupons(),o.forEach(function(e){c.submitCode(e)})};return r.on("itemAdded",s).on("itemRemoved",s).on("clear",s),c})}(sofa,document);